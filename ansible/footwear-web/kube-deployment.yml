---
- name: Setup Kubernetes Cluster
  hosts: control_node
  gather_facts: false
  vars_files:
    - kube-vars.yml

  tasks:
    - name: Update apt
      apt:
        update_cache: yes

    - name: Install docker
      apt:
        name: docker.io
        state: present
        
    - name: Install microk8s
      snap:
        name: microk8s
        state: present
        classic: yes
    
    - name: Add user to docker and microk8s group
      user:
        name: ubuntu
        state: present
        groups:
          - docker
          - microk8s
    
    - name: Wait for microk8s to be ready
      command:
        cmd: microk8s status --wait-ready
      changed_when: false
    
    - name: Create directory for manifests
      file:
        path: "{{ manifest_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: 0775

    - name: Copy manifests to node
      copy:
        src: /home/host/kubernetes/footwear-deployment/{{ item }}
        dest: /home/ubuntu/manifests/
        mode: 0775
      loop: "{{ manifests }}"
    
    - name: Copy template file for DB external service definition
      template:
        src: /home/host/kubernetes/footwear-deployment/db-service.j2
        dest: /home/ubuntu/manifests/db-service.yml
        mode: 0775
